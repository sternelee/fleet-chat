<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fleet Chat æ‹–æ‹½æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-area {
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .drag-zone {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 40px;
            text-align: center;
            background: #fafafa;
            transition: all 0.3s ease;
        }
        .drag-zone.drag-over {
            border-color: #4CAF50;
            background: #f0f8f0;
        }
        .file-info {
            margin-top: 20px;
            padding: 10px;
            background: #e8f4fd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #45a049;
        }
    </style>
</head>
<body>
    <div class="test-area">
        <h1>ğŸ”§ Fleet Chat æ‹–æ‹½åŠŸèƒ½æµ‹è¯•</h1>

        <div class="drag-zone" id="dragZone">
            <h3>ğŸ“¦ æ‹–æ‹½ .fcp æ–‡ä»¶åˆ°è¿™é‡Œ</h3>
            <p>æˆ–è€…ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
            <input type="file" id="fileInput" accept=".fcp" multiple style="display: none;">
            <button onclick="document.getElementById('fileInput').click()">é€‰æ‹©æ–‡ä»¶</button>
        </div>

        <div class="file-info" id="fileInfo">
            ç­‰å¾…æ–‡ä»¶...
        </div>

        <div>
            <h3>ğŸ§ª æµ‹è¯•åŠŸèƒ½ï¼š</h3>
            <button onclick="testDragDrop()">æ¨¡æ‹Ÿæ‹–æ‹½</button>
            <button onclick="checkPlugins()">æ£€æŸ¥æ’ä»¶ç³»ç»Ÿ</button>
            <button onclick="simulateFile()">æ¨¡æ‹Ÿæ–‡ä»¶</button>
        </div>
    </div>

    <script>
        // æ¨¡æ‹Ÿ Fleet Chat æ’ä»¶ç³»ç»Ÿ
        window.pluginLoader = {
            loadPluginFromFile: async function(file) {
                console.log('ğŸ“¦ æ¨¡æ‹ŸåŠ è½½æ’ä»¶:', file.name, file.size, file.type);

                // æ¨¡æ‹Ÿå¤„ç†æ—¶é—´
                await new Promise(resolve => setTimeout(resolve, 1000));

                console.log('âœ… æ’ä»¶åŠ è½½æˆåŠŸ:', file.name);

                // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
                showFileInfo(`âœ… æˆåŠŸåŠ è½½æ’ä»¶: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`);

                return true;
            }
        };

        function showFileInfo(message) {
            const fileInfo = document.getElementById('fileInfo');
            fileInfo.textContent = new Date().toLocaleTimeString() + ': ' + message;
        }

        // æ‹–æ‹½äº‹ä»¶å¤„ç†
        const dragZone = document.getElementById('dragZone');
        const fileInput = document.getElementById('fileInput');

        dragZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dragZone.classList.add('drag-over');
        });

        dragZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dragZone.classList.remove('drag-over');
        });

        dragZone.addEventListener('drop', async (e) => {
            e.preventDefault();
            dragZone.classList.remove('drag-over');

            const files = Array.from(e.dataTransfer.files);
            const fcpFiles = files.filter(file => file.name.endsWith('.fcp'));

            if (fcpFiles.length === 0) {
                showFileInfo('âŒ æ²¡æœ‰æ‰¾åˆ° .fcp æ–‡ä»¶');
                return;
            }

            showFileInfo(`ğŸ“¦ æ£€æµ‹åˆ° ${fcpFiles.length} ä¸ª .fcp æ–‡ä»¶`);

            // ä½¿ç”¨å…¨å±€æ’ä»¶åŠ è½½å™¨
            if (window.pluginLoader) {
                for (const file of fcpFiles) {
                    try {
                        await window.pluginLoader.loadPluginFromFile(file);
                    } catch (error) {
                        console.error('âŒ åŠ è½½å¤±è´¥:', error);
                        showFileInfo(`âŒ åŠ è½½ ${file.name} å¤±è´¥: ${error.message}`);
                    }
                }
            } else {
                showFileInfo('âŒ æ’ä»¶ç³»ç»Ÿæœªåˆå§‹åŒ–');
            }
        });

        fileInput.addEventListener('change', async (e) => {
            const files = Array.from(e.target.files);

            if (files.length === 0) {
                return;
            }

            showFileInfo(`ğŸ“¦ é€‰æ‹©äº† ${files.length} ä¸ªæ–‡ä»¶`);

            if (window.pluginLoader) {
                for (const file of files) {
                    try {
                        await window.pluginLoader.loadPluginFromFile(file);
                    } catch (error) {
                        console.error('âŒ åŠ è½½å¤±è´¥:', error);
                        showFileInfo(`âŒ åŠ è½½ ${file.name} å¤±è´¥: ${error.message}`);
                    }
                }
            } else {
                showFileInfo('âŒ æ’ä»¶ç³»ç»Ÿæœªåˆå§‹åŒ–');
            }
        });

        // æµ‹è¯•åŠŸèƒ½
        function testDragDrop() {
            showFileInfo('ğŸ§ª æµ‹è¯•æ‹–æ‹½åŠŸèƒ½...');

            // åˆ›å»ºæµ‹è¯•æ–‡ä»¶
            const testFile = new File(['test plugin content'], 'test.fcp', {
                type: 'application/octet-stream'
            });

            // æ¨¡æ‹Ÿæ‹–æ‹½äº‹ä»¶
            const dropEvent = new DragEvent('drop', {
                bubbles: true,
                cancelable: true,
                dataTransfer: new DataTransfer()
            });
            dropEvent.dataTransfer.files.add(testFile);

            dragZone.dispatchEvent(dropEvent);
        }

        function checkPlugins() {
            showFileInfo('ğŸ” æ£€æŸ¥æ’ä»¶ç³»ç»Ÿ...');

            if (window.pluginLoader) {
                showFileInfo('âœ… æ’ä»¶ç³»ç»Ÿå·²åŠ è½½');
                console.log('æ’ä»¶åŠ è½½å™¨:', window.pluginLoader);
            } else {
                showFileInfo('âŒ æ’ä»¶ç³»ç»Ÿæœªæ‰¾åˆ°');
            }
        }

        function simulateFile() {
            const content = JSON.stringify({
                name: 'test-plugin',
                version: '1.0.0',
                description: 'Test plugin',
                commands: [
                    { name: 'test', title: 'Test', description: 'Test command' }
                ]
            }, null, 2);

            const blob = new Blob([content], { type: 'application/json' });
            const file = new File([blob], 'test-plugin.fcp', { type: 'application/octet-stream' });

            if (window.pluginLoader) {
                window.pluginLoader.loadPluginFromFile(file);
            } else {
                showFileInfo('âŒ æ’ä»¶ç³»ç»Ÿæœªåˆå§‹åŒ–');
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            showFileInfo('âœ… æµ‹è¯•é¡µé¢å·²åŠ è½½ï¼Œæ‹–æ‹½åŠŸèƒ½å·²æ¿€æ´»');
            console.log('ğŸ”§ æµ‹è¯•é¡µé¢å·²å‡†å¤‡å°±ç»ª');
        });
    </script>
</body>
</html>